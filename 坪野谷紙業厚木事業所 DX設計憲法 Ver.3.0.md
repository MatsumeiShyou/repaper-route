# **坪野谷紙業厚木事業所 DX設計憲法 Ver.3.0**

## **第1部：DX設計憲法 (The DX Design Constitution)**

### **1.1. 序文：本憲法の目的と位置づけ**

本「設計憲法」は、坪野谷紙業厚木事業所における業務DXプロジェクトの基盤となる最上位の原則を定めるものです。これは単なる仕様書ではなく、プロジェクト全体の判断基準であり、将来の仕様変更や関係者間の意見対立が発生した際に立ち返るべき**不変の指針**として機能します。短期的な機能実装の誘惑に抗し、長期的な事業価値の安定性と継続性を最優先するための**判断の拠り所**となることを目的とします。

本憲法の核心思想は、「**人間の判断力と現場の柔軟性を最大限に尊重し、システムはそれを補助・記録するための信頼できる道具であるべき**」という点に集約されます。技術による過度な自動化が現場の混乱を招くリスクを深く認識し、システムが業務を支配するのではなく、業務を遂行する人間がシステムを支配する関係を恒久的に維持します。この憲法は、業務柔軟性への要求、監査可能な証跡の必要性、そして技術の限界という、本来相克する要素に正面から向き合い、その矛盾を解消することで**策定されました**。これは理想論の表明ではなく、現実を航海するための実践的な憲章です。

以下に詳述する原則群は、この思想を具現化するための具体的な行動規範であり、我々が守るべき一線となります。

### **1.2. 最上位原則：我々が絶対に破らないこと**

本セクションで詳述する4つの原則は、この憲法の核心であり、プロジェクトの長期的な健全性を担保するための揺るぎない基盤です。いかなる状況においても、これらの原則が遵守されることを最優先とします。

###### **人間の最終判断権は常に最優先**

システムは、人間の判断を代替するものではなく、その質を高めるための支援ツールでなければなりません。この原則は、予期せぬ事態への対応力を担保し、責任の所在を明確にするために不可欠です。例えば「積載量が0kgでなければ車両スワップは不可」という安全性ルールと、「現場では緊急で柔軟なスワップが必要」という業務要求の矛盾に対し、システムは自動判断を行いません。代わりに、権限を持つ人間が「強制操作（is\_admin\_forced）」フラグを用いて例外を許可する経路を提供します。これにより、システムは安全性の担保に貢献しつつ、人間は業務の柔軟性と最終的な説明責任の両方を維持できます。

* **システムの役割の限定** システムの役割は、データに基づく「提案」と、行われた操作の正確な「記録」に限定します。  
* **自動確定・自動判断の禁止** システムが業務データを自動で「確定」したり、例外状況を自動で「判断」したりする機能は実装しません。最終判断は、必ず権限を持つ人間の明示的な操作を介して行われます。  
* **責任の所在の明確化** 全ての重要な意思決定の最終責任は人間が負うことを前提とします。

###### **状態と履歴は不可逆**

過去の事実は、たとえそれが誤りであったとしても、改ざんされてはなりません。事実は事実として記録され、その後の変更はすべて新たな「イベント」として追跡可能であるべきです。これは、完全な監査証跡を担保し、将来の業務分析における価値ある資産を構築するために存在します。例えば、回収案件を単純にデータベースから`DELETE`（削除）するのではなく、訪問したが回収できなかった事象を`is_skipped=true`という新たなイベントとして記録します。これにより、当初の計画と実際に起きた結果の両方を保存でき、正確な不在率の算出など、将来のデータ分析にとって**不可欠な要素**となります。

* **データの更新原則** 重要な業務レコードの直接的な上書き更新（`UPDATE`）を原則として避け、変更内容を新しいレコードとして追加（`INSERT`）する設計を基本とします。  
* **イベントとしての変更記録** すべての重要な状態変更は、変更前後の状態、操作者、タイムスタンプ、そして「理由」と共にイベントログとして記録します。  
* **完全な監査証跡の担保** システム上のあらゆる変更が「誰が、いつ、何を、なぜ」行ったのかを完全に追跡可能にします。

###### **現場例外を否定しない**

業務は常に計画通りに進むとは限りません。システムは理想的なフローを提示するべきですが、現実の業務で発生する例外的な事態を許容する柔軟性を持たなければ、現場で活用されないツールとなってしまいます。システムは、権限を持つ担当者による通常のバリデーションルールを超える緊急操作を許容しますが、それらはすべて「強制操作」として明確に識別・記録されなければなりません。これにより、例外は管理不能なリスクではなく、将来の業務プロセス改善に繋がる分析可能なデータへと転換されます。

* **緊急操作・例外的操作の許容** 権限を持つ担当者による、通常のバリデーションルールを超える緊急操作（例：積載中の車両スワップ）をシステムとして許容します。  
* **例外の可視化と記録** すべての例外操作は「強制操作」として明確に識別され、その実行ログは通常操作以上に詳細に記録することで、安易な例外処理の乱発を抑制します。  
* **現実との乖離防止** この原則は、システムが**実態と乖離した設計**となることを防ぐための最も重要な安全弁です。

###### **最適化よりも安全性と可読性**

システムの内部ロジックは、開発者だけでなく、将来の運用担当者にも理解可能であるべきです。短期的なパフォーマンス向上のために、システムの透明性を犠牲にすることは許されません。論理計算のプロセスが人間にとって解釈不能な「ブラックボックス（深層学習等の推論過程）」となるロジックの導入は厳格に禁止し、数学的根拠が明確で再現性のあるアルゴリズム（決定論的設計）を最優先します。

* **ブラックボックスの禁止** AIによる自動判断など、その決定プロセスが人間にとってブラックボックス化するロジックの導入は厳しく制限します。導入する場合でも、その判断根拠を人間が理解できる形で提示する責務を負います。  
* **シンプルな設計の優先** 標準的な技術を採用し、特定の個人に依存しない、可読性と保守性の高い設計を維持します。  
* **修正可能性の担保** システムに問題が発生した際、迅速に修正箇所を特定できることを、機能の高度化よりも優先します。

これらの原則に基づき、システムと人間の具体的な役割分担を次章で定義します。

### **1.3. 判断の境界線：システムと人間の役割分界**

最上位原則に基づき、システムと人間の責任範囲を明確に分けることは、データの曖昧さをなくし、プロジェクト全体の一貫性を保つために不可欠です。以下にその境界線を定義します。

| システムが責任を持つ領域（やること） | システムが責任を負わない領域（やらないこと） | 人間が必ず判断すべき領域 |
| :---- | :---- | :---- |
| \* 確定したルールに基づくデータの計算（例：実績の按分計算）\<br\>\* 状態変更の正確な記録とログの保管\<br\>\* 人間による最終判断を前提とした、マスターデータに基づく『下書き』の提示\<br\>\* ルール違反の可能性に対する「警告」の表示\<br\>\* データの整合性の維持 | \* 業務計画の自動「確定」\<br\>\* 警告を無視した操作の最終判断\<br\>\* 理由なきデータ変更の受付\<br\>\* 業務ルールの自動解釈と変更 | \* 配車計画の「一次確定」の実行\<br\>\* 業務中に発生した例外事象への対応判断（スワップ、強制操作等）\<br\>\* 警告が表示された操作を、リスクを理解した上で実行するかの判断\<br\>\* 実績データの最終的な検収と確定\<br\>\* マスターデータ（コース、顧客、車両等）の維持管理 |

この役割分担は、\*\*Single Source of Truth（唯一の信頼できる情報源）\*\*を確立します。

* **システム**は「**何が記録されたか**」の真実の源泉です。  
* **人間**は「**なぜその判断が下されたか**」の真実の源泉です。

この原則は交渉の余地なく守られなければなりません。この明確な分界線は、将来の機能追加を評価する際の基盤となります。

### **1.4. 将来の機能追加における評価ルール**

プロジェクトが初期の思想から逸脱しないよう、すべての新規機能や施策は、実装を検討する前に以下の憲法に照らして評価されなければなりません。

* **憲法適合性** その機能は、本設計憲法のいずれかの原則、特に「人間の最終判断権は常に最優先」の原則に反していないか？  
* **実装時期の妥当性** それは「今」解決すべき中核的な課題か？それとも将来構想（バックログ）として管理し、より重要な課題を優先すべきか？

本憲法は、プロジェクトに関わる全てのメンバーの判断のブレを防ぎ、思考を方向付けるための共有されたフレームワークです。

## **第2部：業務OS設計原則 (Business OS Design Principles)**

### **2.1. 序文：原則が描く業務の未来像**

第1部で定義した「設計憲法」は、プロジェクトの思想的な拠り所です。本章では、その抽象的な思想を、現場で日々利用される具体的な業務アプリケーションの設計に落とし込むための「設計原則」を定義します。これらの原則は、憲法の精神をコードとインターフェースの隅々にまで浸透させ、一貫性があり、堅牢で、直感的に使えるシステムを構築するための実践的な設計図です。これは厚木事業所全体の「ビジネスOS」を構築するための原則となります。

### **2.2. アーキテクチャ原則**

システム全体の技術構成は、憲法の「最適化よりも安全性と可読性」という原則を体現するため、標準的で堅牢な技術を選択します。このアーキテクチャは\*\*「Hot/Log/Media 分離保管」\*\*の思想に基づき、データの役割に応じて最適な保管場所を選択します。

* **クライアント (Client)**  
  * **PWA (Progressive Web App)** を基本とし、PCでの利用を主軸に設計します。  
  * オフライン時でも参照や一部入力が可能となるよう、Service WorkerとIndexedDBを活用します。  
  * アクセシビリティ標準 **WCAG 2.1 AA** に準拠し、全ての利用者が情報にアクセスできるよう配慮します。  
* **バックエンド (Backend)**  
  * 日々の業務で高頻度にアクセスされる「**Hotデータ**」の中核データベースとして **Supabase (PostgreSQL)** を採用し、認証やストレージ機能も活用します。  
  * 管理側アプリとドライバー側アプリは機能的に分離しつつ、データベースは共有するモデルを採用します。  
* **外部連携 (External Integration)**  
  * 人間が直接閲覧・監査するための「**Logデータ**」の退避先として **Google Sheets** を利用し、可読性と長期保管性を確保します。  
  * 回収実績の証憑画像などの「**Mediaデータ**」は、堅牢なオブジェクトストレージである **Cloudflare R2** に保管します。

このアーキテクチャは、特定の技術への過度な依存を避け、データの保管場所を役割に応じて分離することで、システム全体の安全性と将来の拡張性を担保します。

### **2.3. データモデル原則**

業務の現実を正確にデータ構造に反映させることは、システムの堅牢性と将来性を決定づける極めて重要な要素です。

###### **マスターデータの三層分離**

請求処理の関心事と配車計画の関心事をシステムレベルで分離するため、マスターデータを以下の三層に明確に分離します。

* **支払先マスター (Payer)**: 当社に仕入先を紹介し、支払いの主体となる企業情報。  
* **仕入先マスター (Supplier)**: 実際に契約関係にある発生元情報（旧: 顧客）。  
* **回収先マスター (Destination)**: ドライバーが実際に訪問する物理的な場所の情報。配車管理アプリケーションが主に関心を持つのはこのマスターです。

この設計思想により、請求や契約の複雑性が「どこへ、いつ行くか」という純粋な配車業務ロジックを汚染することを防ぎます。

###### **証跡の完全性**

憲法の「状態と履歴は不可逆」という原則をデータレベルで実現するため、全ての重要な状態変更は`event_logs`テーブルに記録されます。

* **記録対象**: スワップ、管理者による強制操作、実績データの修正など、業務の正当性に関わる全ての操作。  
* **記録内容**:  
  * 変更前（before）と変更後（after）のデータスナップショット  
  * 操作者  
  * タイムスタンプ  
  * 強制操作フラグ  
  * 修正理由

これにより、「誰が、いつ、何を、なぜ」変更したかが常に追跡可能となり、監査への完全な対応と、トラブル発生時の迅速な原因究明を可能にします。

### **2.4. 中核ワークフロー原則：二段階確定モデル**

現行業務の思想（印刷して配布）を尊重しつつ、デジタル化のメリットを最大化するため、核心的なワークフローとして「二段階確定モデル」を採用します。

* **ステップ1：一次確定（業務前）**  
  * **タイミング**: その日の業務開始前、配車担当者が計画を完了した時点。  
  * **意味**: 従来の「計画を印刷して配布する」という行為のデジタル版であり、「この計画で本日の業務を開始する」という**責任の宣言**です。  
  * **システム上の挙動**: 関連する配車データのステータスが `confirmed` となり、以降の通常編集はロックされます。  
* **ステップ2：例外イベントとしての業務中変更**  
  * **思想**: 業務中に発生する計画変更（車両トラブルによるスワップ等）は、「一次確定した計画の修正」ではなく、「**確定計画に対する例外イベント**」として扱います。  
  * **システム上の挙動**: 計画データそのものは変更せず、`event_logs`に変更内容を記録します。画面には、このイベントを反映した「最新の指示」が表示されます。

このモデルがもたらす究極的な価値は、「**我々が意図したこと（計画）**」と「**実際に起きたこと（現実）**」の両方をデジタルに保存し、従来の紙と電話による運用の曖昧さを解消し、業務の混沌を分析可能なデータへと転換することにあります。

### **2.5. UI/UX設計原則**

利用者のITリテラシーに依存せず、誤操作を防ぎ、現場の判断を尊重するため、一貫したUI/UX設計原則を定めます。

###### **2.5.1. 操作原則：判断と実行の分離**

操作の意図を明確に分離し、誤操作による業務トラブルを未然に防ぎます。

* **シングルクリック（タップ）**: データの状態を確認するための「文脈を開く」操作に限定します。データは変更されません。  
* **ダブルクリック**: 原則として使用しません。  
* **右クリック（長押し）**: 既存の機能への「ショートカット」としてのみ、限定的に使用します。

###### **2.5.2. タブレット対応とジェスチャーの抽象化**

将来のデバイス多様化に対応するため、操作方法と業務意味を分離します。マウス操作（クリック、右クリック）とタッチ操作（タップ、長押し）は、それぞれ「詳細表示」「操作候補を開く」といった同等の業務意味を持つように抽象化します。

###### **2.5.3. 警告と制約の表現**

システムは「禁止」するのではなく、「警告」して人間の判断を促すことを基本とします。ルール違反が発生した場合、操作を即座にブロックせず、問題を示す警告を表示します。実行は許容しますが、その操作は例外ログとして記録されます。管理者権限による強制操作は、UI上で通常操作と明確に区別され、その重みが伝わるように設計します。

###### **2.5.4. リファレンス実装におけるUI設計思想**

上記原則を具現化する動的配車管理アプリケーションのUIは、「**Excelライクな直感性**」と「**高密度な情報表示**」を両立させ、プロ仕様の配車盤として機能します。

* **基本構成**: 縦軸にコース、横軸に時間を配したガントチャートを主画面とします。縦軸（コース）と横軸（時間）はスクロール時にヘッダーが固定（sticky）表示され、全体の位置関係を常に把握できます。  
* **精密な時間表現**: 時間スケールは**1時間あたり128px**を基準とし、15分（32px）を最小操作単位とします。これにより、直感的ながらも精密な計画策定を可能にします。  
* **Smart Coloring ロジック**: 案件カードの色は、隣接する案件（同一ドライバーの直前案件、隣のドライバーの重複時間案件）と色が被らないよう、18色のパレットから自動で割り当てられます。これにより、視覚的な衝突を回避し、全体の可読性を高めます。  
* **直感的なインタラクション**: ドラッグ＆ドロップによる時間変更やスワップが可能です。ドラッグ中は、配置可能ならエメラルド枠、重複不可なら赤枠でプレビューが表示され、操作の結果を事前にフィードバックします。  
* **階層化された情報表示 (Z-Index)**: 現在時刻線や選択中の案件カードは常に最前面（Z-Index: 40）に、通常の案件カードは中層に（Z-Index: 20）、背景グリッドは最背面に（Z-Index: 0）と、情報の重要度に応じて表示レイヤーが厳密に管理されます。

これらの原則は、将来のすべての業務インターフェースに対する耐久性のあるフレームワークとなります。

## **第3部：リファレンス実装計画と将来構想 (Reference Implementation & Future Concepts)**

### **3.1. 序文：思想から実践へ**

これまで定義した憲法と原則を具現化する最初の成果物として「動的配車管理アプリケーション」を位置づけます。このアプリケーションは、本マスタープランの思想が正しく実践可能であることを証明するためのリファレンス実装です。ここでは、まず実現すべき中核価値（MVP）と、将来構想を明確に分離し、プロジェクトの焦点を維持します。

### **3.2. リファレンス実装：動的配車管理アプリケーション**

本アプリケーションのMVP（Minimum Viable Product）は、日々の配車業務の根幹を支える以下の機能に集中します。

* **動的配車ガントチャート** 縦軸にコース、横軸に時間を配し、その日の配車状況全体を視覚的に把握・操作するためのメイン画面です。  
* **スワップ機能** 「車両スワップ」と「コーススワップ」を提供し、管理者による強制操作も可能です。  
* **実績検収機能** ドライバー入力値と事務所計量値を照合し、「**ドライバー入力比率 × 事務所総量**」のアルゴリズムに基づき最終実績を按分計算します。  
* **ログ・監査機能** 全ての強制操作やデータ修正など、重要な業務イベントを「誰が、いつ、なぜ」行ったかの情報と共に記録します。  
* **未配車リスト管理** 「スポット」「時間指定」「特殊案件」といった制約を持つ未配車案件を、専用タブで分類・管理します。

これらの機能により、まずは日々の配車業務のデジタル化と可視化を実現します。

### **3.3. 未実装アイディア・将来構想（バックログ）**

以下の構想は、本プロジェクトの長期的なビジョンとして価値が高いものですが、中核機能の安定稼働を最優先するため、現時点では実装せず、将来の検討課題として管理します。

###### **朝の配車計画「自動展開」ロジック**

* **構想**: 毎朝、Google Sheetsで管理されている出勤表をシステムが読み込み、出勤メンバー、「現場支援」や「早出」といった勤務形態、資格等を考慮して配車計画の「初期案」を自動生成する機能です。  
* **思想**: これは配車担当者の判断を補助するための\*\*「下書き作成機能」\*\*であり、最終的な調整と確定は人間が行い、「人間の最終判断権」の原則を遵守します。

###### **実績データによる予測・分析機能**

* **構想**: 蓄積された実績データを活用し、天候や曜日から特定の案件の遅延リスクを統計的に算出する「遅延リスク可視化」や、顧客ごとの不在率を可視化する「不在率分析ダッシュボード」を実現します。

###### **最適ルートの自動提案**

* **構想**: 複数のスポット案件に対し、移動距離や時間制約を考慮した最も効率的な巡回ルートをシステムが計算して「提案」する機能です。  
* **思想**: これもあくまで「提案」に留まり、最終的な採用判断は配車担当者が行います。システムは判断材料を提供するだけであり、決定権は常に人間にあります。

本憲法と設計原則は、坪野谷紙業厚木事業所のDXを成功に導くための礎です。この文書を共有された指針として、我々は一貫性と継続性のある価値創造を実現していきます。

## **補遺：本憲法の解釈と適用に関する注意事項**

### **A. 技術名・プロダクト名の位置づけについて**

本憲法には、Supabase、PWA、Google Sheets等、具体的な技術名・サービス名が登場します。これらは、**現時点において「安全性・可読性・標準性」という本憲法の思想を最も分かりやすく体現している代表例**として挙げられており、特定の技術選択を将来にわたって拘束するものではありません。

本憲法において拘束力を持つのは、以下の思想そのものです。

* 最適化よりも安全性と可読性を優先すること  
* 特定個人やブラックボックスに依存しない構造を維持すること  
* 修正可能性と説明可能性を常に担保すること

将来、より適切にこれらの思想を満たす技術が登場した場合、それらへ置き換える判断は本憲法に**適合**する行為です。

**技術名は例示であり、拘束力を持つのは常に「思想」である。**

### **B. 本憲法の“絶対視”による硬直化を防ぐための解釈**

本憲法は「絶対に破ってはならない原則」を定めていますが、それは**現実の業務を否定するための禁止条項集**ではありません。

本憲法が守ろうとしているのは、

「判断を消さないこと」

「理由なき変更を許さないこと」

「責任の所在を曖昧にしないこと」

であり、**例外や逸脱そのものを排除することが目的ではない**ことを意味します。したがって、以下の点を本憲法の正規の解釈として共有します。

* 本憲法に明示されていない行為は、即座に禁止されるものではありません。

重要なのは

誰が

いつ

なぜ

どの原則を理解した上で

その判断を行ったかが、説明可能な形で残されていることである

本憲法は「思考停止の根拠」として使われることを意図していません。むしろ、**判断を下すために考えるべき論点を増やし、判断の質を高めるための道具**です。

本憲法の原則に照らした上で、人間が責任を持って行った判断と、その理由が適切に記録されている限りにおいて、その判断は本憲法の精神に反しない。

### **補遺の位置づけ**

本補遺は、憲法本文と同等の効力を持つ「公式解釈」であり、将来の設計・実装・運用において、本憲法を適用する際の前提条件として参照されるものとします。
