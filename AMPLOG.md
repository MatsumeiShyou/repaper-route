# Asset Modification Proposal (AMP) LOG

| 日付 | 項目 | 内容 | 承認状況 | 承認印 |
| :--- | :--- | :--- | :--- | :--- |
| 2026-02-07 | SDR 統治基盤導入 | 意思決定テーブル (`decision_proposals`, `decisions`) の作成 | 済 | (PW: ｙ) |
| 2026-02-08 | データベース初期構築 | 顧客・車両・品目・ジョブ等の基本テーブル作成と初期データ投入 | 済 | (PW: ｙ) |
| 2026-02-11 | 運用不具合修正 | ジョブステータス不整合、RLSポリシー、RPC動作修正 | 済 | (PW: ｙ) |
| 2026-02-14 | DXOS (Developer Experience Operating System) 導入 | 統治憲法 (`AGENTS.md`) 刷新とプリフライトスクリプト等の配備 | 済 | (PW: ｙ) |
| 2026-02-14 | マスタ管理 UI 刷新 (Phase 5) | 全マスタ画面の SDR 準拠化、汎用 RPC 導入 | 済 | (PW: ｙ) |
| 2026-02-14 | 物理的統治ゲート有効化 | Husky `pre-commit` への `pre_flight.js` 登録 | 済 | (PW: ｙ) |
| 2026-02-14 | 配車初期化ロジック修正 | `routes` テーブルの空保存によるデータ消失不具合の解消 | 済 | (PW: ｙ) |
| 2026-02-15 | 緊急復旧 | PendingJobSidebar ホワイトアウト修正 (ガード追加) | 済 | (PW: ｙ) |
| 2026-02-15 | 配車盤ヘッダー同期 | JS版との機能差異解消 (Undo/Redo追加, 日本語化) | 済 | (PW: ｙ) |
| 2026-02-15 | ドライバーヘッダー同期 | JS版のデザイン忠実再現 (黄色帯, ダークテーマ, 1行化) | 済 | (PW: ｙ) |
| 2026-02-15 | 配車盤位置ズレと構文エラーの根本修正 | 各コンポーネント幅の px 固定および return 文復元 | 済 | (PW: ｙ) |
| 2026-02-15 | 統治憲法改訂 | AGENTS.md に「動作確認依頼の義務」を追加 | 済 | (PW: ｙ) |
| 2026-02-15 | Master Points High-Density Relation | 拠点・排出元・支払元を統合したビューの導入 | 済 | (PW: ｙ) |
| 2026-02-15 |Logo & Logo Text Sync (SANCTUARY) | 管理ポータルのロゴ・テキストを SANCTUARY に統一 | 済 | (PW: ｙ) |
| 2026-02-16 | JS資産隔離 & TS(SANCTUARY)昇格 | 二重帝国状態を解消。TypeScript 環境をプロジェクト正典化 | 済 | (PW: ｙ) |
| 2026-02-16 | UI スタイリング復旧修正 | ディレクトリリネームに伴う Tailwind スキャンパス修正 | 済 | (PW: ｙ) |
| 2026-02-16 | Tooling & Governance Refinement | `type-check`, `lint` スクリプトの TS 対応と物理強制 | 済 | (PW: ｙ) |
| 2026-02-17 | Refiner Cleanup & Test Restore | ジャンクファイル削除とテスト環境 (Vitest) の復旧 | 済 | (PW: ｙ) |
| 2026-02-17 | Refiner Zero Baseline | ESLint Flat Config 移行、構文修正、未使用コードの削除 | 済 | (PW: ｙ) |
| 2026-02-17 | 回収先マスターの機能強化 (Evolution) | 現場制約（車両制限等）の保持と会計・現場の分離設計を導入 | 持込 | (PW: ｙ) |

---

## 申請詳細: DXOS 導入と物理的統治 (2026-02-14)
### 1. 概要 (State)
開発者の自己判断による資産破壊や不透明な変更を防止するため、物理的に変更を監視・制限するシステムが必要であった。
### 2. 判断 (Decision)
- `AGENTS.md` v3 統治憲法を起草。
- プロプリエタリな `pre_flight.js`, `check_seal.js` を導入。
- Husky を使用し、コミット前にこれらのスクリプト実行を物理的に強制する。
### 3. 理由 (Reason)
- ヒューマンエラーを「注意」ではなく「システム」で解決し、長期的な保守性と透明性を担保するため。

---

## 申請詳細: マスタ管理 UI 刷新 (2026-02-14)
### 1. 概要 (State)
各マスタ（車両、品目、拠点、ドライバー、ユーザー）ごとにバラバラな実装が行われており、SDR プロトコルへの対応が未完了であった。
### 2. 判断 (Decision)
- 全マスタの登録・更新を集約する汎用 RPC `rpc_execute_master_update` を導入。
- 5173 ポートの管理 UI を SDR (State/Decision/Reason) 準拠の `MasterDataLayout` 方式に全面刷新。
### 3. 理由 (Reason)
- 全ての変更を監査可能にし、かつ実装の重複を排除して開発生産性を高めるため。

---

## 申請詳細: 配車盤ヘッダー同期 (2026-02-15)
### 1. 概要 (State)
JS 版には存在するが TS 版で欠落している「履歴操作 (Undo/Redo)」機能、およびヘッダーの日本語化・デザイン不整合を解消する。
### 2. 判断 (Decision)
- `useBoardData.ts` の履歴ロジックを実装。
- `BoardCanvas.tsx` のヘッダーにアイコンボタンを追加し、日本語化。
### 3. 理由 (Reason)
- ユーザーの要望「JS 版との差分をなくす」に基づき機能・視覚的整合性を確保するため。

---

## 申請詳細: JS資産隔離 & TS(SANCTUARY)昇格 (2026-02-16)
### 1. 概要 (State)
JS/TS 混在の「二重帝国」状態により、認知的負荷と不整合リスクが発生していた。
### 2. 判断 (Decision)
- 旧 `src` を `src-legacy-js` に退避。
- `src-ts` を `src` に昇格し、5173 ポートに固定。
### 3. 理由 (Reason)
- 統治の純度を高め、型安全性によるガバナンス強化を物理構成レベルで確定させるため。

---

## 申請詳細: Refiner Zero Baseline (2026-02-17)
### 1. 概要 (State)
TS 移行後に溜まった型・Lintエラー、および未使用コードが「統治のノイズ」となっていた。
### 2. 判断 (Decision)
- ESLint Flat Config への完全移行。
- `App.tsx` の構文破壊修正。
- `collision.ts`, `theme.ts`, `TimeGrid.tsx` の未使用引数の削除。
- `useMasterCRUD.ts` の型エラー一時抑制によるベースライン確立。
### 3. 理由 (Reason)
- エラー 0 (Zero Baseline) を達成し、真に注意すべき変更を浮き彫りにするため。

---

## 申請詳細: UIラベルの変更 (2026-02-17)
### 1. 概要 (State)
現行の「稼働中/非稼働」という表示が直感的でないという指摘を受けた。
### 2. 判断 (Decision)
- `MasterDataLayout.tsx` および `masterSchema.ts` の日本語ラベルを「有効/無効」へと置換。
### 3. 理由 (Reason)
- ユーザーの直感的理解を助け、誤操作を防止するため。

| 2026-02-17 | Refiner Operation "Crystal Clear" | 型安全性強化 (`@ts-nocheck`排除) とUIロジックのスキーマ移譲 | 済 | (PW: ｙ) |

---

## 申請詳細: Refiner Operation "Crystal Clear" (2026-02-17)
### 1. 概要 (State)
`useMasterCRUD.ts` の型エラー隠蔽 (`@ts-nocheck`) と `MasterDataLayout.tsx` のハードコードされたスタイルロジックが、統治の純度と拡張性を阻害していた。
### 2. 判断 (Decision)
- `useMasterCRUD.ts` から `@ts-nocheck` を削除し、完全な型定義を実装。
- `masterSchema.ts` に `styleRules` を追加し、UIの表示ロジックをデータ定義に移譲。
- 実在しない「10t」ロジックを削除し、「4t以下」を基準とした拡張可能な設計へ変更。
### 3. 理由 (Reason)
- 隠蔽されたエラー（負債）を精算し、将来の変更（車種追加等）におけるコード修正リスクをゼロにするため。

---

## 申請詳細: 回収先マスターの機能強化 (2026-02-17)
### 1. 概要 (State)
現行の回収先マスタは最小限の項目しかなく、現場の物理制約（車両制限、時間制限）や業務実態（午前/午後便の分離）を適切に保持できていない。
### 2. 判断 (Decision)
- ハイブリッドPK戦略を採用（既存の `location_id` を維持しつつ、真のIDとして `id (UUID)` を追加）。
- 現場の暗黙知を形式知化するための14のカラム（車両制約タイプ、訪問スロット、入場手順、安全特記等）を一挙に追加。
- 経理（契約）と現場（場所）を分離するため `contractor_id` への参照を強化。
### 3. 理由 (Reason)
- Aフェーズ（計画）における判断事故（入れない車両の配車など）を物理的に防ぎ、将来の自動配車AIのための高精度な教師データを蓄積するため。
| 2026-02-17 | モーダルUI改善とフィールド統合 | Modal.tsx, MasterDataLayout.tsx, masterSchema.ts | スクロール対応と2列化により視認性を向上。また入場手順等を『備考』に統合しUIを簡略化 | User (Approved) | 承認 (PW: ｙ) |
| 2026-02-17 | 品目タグシステム導入とマスタ項目整理 | Modal.tsx, MasterDataLayout.tsx, masterSchema.ts | 品目マスタ連動のタグ選択UIを導入。デフォルトコース削除と備考統合によりUIをさらにスリム化 | User (Approved) | 承認 (PW: ｙ) |
| 2026-02-17 | 回収先マスタ編集時のホワイトアウト修正 | MasterDataLayout.tsx | useMasterCRUD への引数不整合を解消し、モーダル表示時のクラッシュを修正。 | User (Approved) | 承認 (PW: ｙ) |
| 2026-02-17 | 回収先マスタの便区分重複修正 | masterSchema.ts | 意図せず重複していたカラム定義を削除し、マスタ一覧の表示を正常化 | User (Approved) | 承認 (PW: ｙ) |
