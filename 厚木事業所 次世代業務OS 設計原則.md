# **厚木事業所 次世代業務OS 設計原則**

本書は「坪野谷紙業厚木事業所 DX設計憲法」に従属する。
本書の記載内容は、憲法の解釈および具体化を目的とするものであり、
憲法に反する解釈・実装・運用を正当化するものではない。

## **― DX設計憲法を実装判断へ翻訳するための不変原則 ―**

### **序文：本原則の目的と位置づけ**

本ドキュメントは、単一のアプリケーションの仕様書ではない。これは、坪野谷紙業厚木事業所における将来の全ての業務アプリケーション開発の基盤となる、いわば「ビジネスOS」の設計原則を定義するものである。我々が策定した最上位理念である「DX設計憲法」は、プロジェクトの不変の北極星として機能する。しかし、日々の開発現場では、迅速なリリースを求める「ビジネス・MVP志向」、既存の慣習を維持しようとする「現場ロジック」、そして技術的な完成度を追求する「技術的理想状態」という三つの要請が絶えず衝突する。

本原則は、その憲法の思想を、実装や運用上の判断に直結する具体的かつ実践的なルールへと翻訳し、これらの矛盾を乗り越えるための羅針盤となることを目的とする。憲法の理念と現場の実践との間に橋を架け、抽象的な理想を具体的なアーキテクチャへと落とし込むための設計言語である。

これらの原則に一貫して従うことは、「現場が破綻しない一本の『物語』」を紡ぎ出すことに他ならない。これにより、我々が開発する全てのシステムは、一貫性を持ち、内部統制に耐えうる安全性を備え、そして何よりも現場で直感的に使い続けられる信頼性の高い道具となる。これは、長期的な事業価値を最大化するための唯一の方法であると、我々は確信する。

\--------------------------------------------------------------------------------

### **1\. アーキテクチャの階層化：変更耐性と保守性の担保**

本ビジネスOS設計思想の核心は、システムの階層化にある。これは、モノリシックなシステムを典型的に不安定化させる技術の陳腐化やビジネス要件の進化に対する、我々の主要な防御策である。システム全体を「データ中枢」「業務フロー」「アプリケーションUI」の三層に明確に分離し、各層が独立した責務と変更サイクルを持つことで、一部の改修がシステム全体に予期せぬ影響を及ぼすリスクを最小限に抑え、長期的な保守性と変化への耐性を担保する。

この戦略に基づき、システムを以下の三層構造で定義する。

| 階層 | 責務 | 変更頻度 | 構成要素の例 |
| :---- | :---- | :---- | :---- |
| **データ中枢（不変層）** | 事業の「事実」を恒久的に記録する。 | 低（数年に一度） | ・マスターデータの三層分離モデル\<br\>・INSERT-onlyのイベントログ構造\<br\>・PostgreSQLのテーブルスキーマ |
| **業務フロー（半固定層）** | 業務の「ルール」を定義・実行する。 | 中（半期～年次） | ・二段階確定ワークフロー\<br\>・スワップ機能のバリデーションロジック\<br\>・実績データの按分アルゴリズム |
| **アプリケーションUI（可変層）** | 人間が業務ルールを「操作」するための接点。 | 高（随時） | ・動的配車ガントチャートのレイアウト\<br\>・実績検収モーダルの項目\<br\>・警告メッセージの文言 |

これらの層は、互いに依存しつつも疎結合に保たれる。例えば、現場からの要望に応じたUIの改善（可変層）は、事業の根幹であるデータ構造（不変層）に一切影響を与えずに実施できる。逆に、データ構造の絶対的な安定性が、その上で動作する全てのアプリケーションの堅牢性を力強く支える。この思想は、特に事業の根幹をなすマスターデータの設計において、より具体的に展開される。

\--------------------------------------------------------------------------------

### **2\. マスターデータの三層分離：請求と配車の責務分界**

請求という「経理上の関心事」と、配車という「現場のオペレーション」は、似て非なるものである。これらをシステムレベルで明確に分離することは、極めて重要な戦略的判断である。この分離は、将来の会計慣行の変更や契約形態の多様化といったビジネスサイドの変動から、日々の配車業務の安定性を守るための堅牢な防壁として機能する。この原則に基づき、マスターデータを以下の三層構造で定義する。

| マスター層 | 目的 | データの役割と管理単位 |
| :---- | :---- | :---- |
| **支払先マスター** | 請求処理の主体を管理 | 会計システムと連携する支払いの主体情報。\<br\>例：「(合)ポジティブ」 |
| **仕入先マスター** | 契約関係の主体を管理 | 当社との直接的な契約主体情報。支払先マスターと紐づく。\<br\>例：「ﾁｸﾌﾞP上溝事業所(ﾎﾟｼﾞﾃｨﾌﾞ)」 |
| **回収先マスター (Destination)** | 配車業務の実行単位を管理 | ドライバーが訪問する物理的な回収先・場所の情報（住所、品目、時間制約等）。配車アプリが主に関心を持つ。\<br\>例：「(株)ﾁｸﾌﾞﾊﾟｯｹｰｼﾞ上溝事業所」 |

#### **具体例：回収先ID "1" のケース**

この三層構造は、実際のデータとして次のように表現される。これにより、データ間の関係性がコードではなくIDによって明確に定義され、各層の責務が分離される。

**支払先:** (合)ポジティブ (支払先コード: 1709000\) **仕入先:** ﾁｸﾌﾞP上溝事業所(ﾎﾟｼﾞﾃｨﾌﾞ) (仕入先コード: 1709032\) **回収先:** (株)ﾁｸﾌﾞﾊﾟｯｹｰｼﾞ上溝事業所 (回収先ID: 1\)

この設計がもたらす戦略的価値は計り知れない。配車アプリケーションは「回収先ID: 1」の物理的な場所と作業内容にのみ関心を持てばよく、その背景にある契約関係や請求主体といった複雑性から完全に解放される。この責務の分離こそが、変化に強く、かつ現場で使いやすいシステムを実現するための礎となるのである。

\--------------------------------------------------------------------------------

### **3\. 二段階確定モデル：計画と現実のデータを両立させる中核ワークフロー**

本ワークフローは、DX設計憲法の「状態と履歴は不可逆」という原則に、日々の業務の中で生命を吹き込む中核的な仕組みである。その目的は、「意図したこと（計画）」と「実際に起きたこと（現実）」の両方を、失うことなくデータとして保存することにある。これにより、従来の紙と電話による運用の曖昧さを排除し、「計画を立て、実行し、例外に対応する」という現場の業務サイクルを忠実にデジタル化する。

**一次確定（業務前）**

**タイミング:** その日の業務開始前に、配車担当者が計画を完了した時点。

**業務上の意味:** この操作は、従来の「計画を印刷して配布する」という行為のデジタル版であり、単なる保存操作ではない。「この計画で本日の業務を開始する」という責任の宣言である。

**システム挙動:** `route_shifts.status`が`confirmed`となり、以降の通常編集はロックされる。この瞬間に`route_shifts.confirmed_at`カラムが記録され、計画が公式に開始された不変のタイムスタンプとして機能する。

**例外イベントとしての業務中変更**

**思想:** 業務中に発生する計画変更（例：車両トラブルによるスワップ）は、「確定計画の修正」として扱ってはならない。本モデルの核心は、これを「確定計画に対する例外イベント」として扱う思想にある。

**計画が間違っていたのではなく、現実が変わったのです。**

**システム挙動:** `confirmed`状態の計画データは一切変更せず、全ての変更内容（`before`/`after`のデータスナップショット、操作者、強制操作フラグ、理由など）を`event_logs`テーブルにINSERT-only（追記のみ）で記録する。ドライバーや管理者の画面には、このイベントログを反映した「最新の指示」が表示される。

このモデルによって、「当初の計画（Plan）」と「現実の運用（Do）」の両方のデータが欠損なく保存される。これは、単に過去を追跡するためだけではない。計画と現実の差異を分析可能にすることで、将来の計画精度を向上させるための、極めて価値の高い資産となるのである。

\--------------------------------------------------------------------------------

### **4\. 証跡の完全性：不可逆なログ設計原則**

DX設計憲法の最上位原則である「状態と履歴は不可逆」をデータレベルで具現化するのが、このログ設計原則である。システム上のあらゆる変更が「誰が、いつ、何を、なぜ」行ったのかを完全に追跡可能にすることは、内部統制、トラブルシューティング、そして将来の業務分析に不可欠な資産となる。その完全性を担保するため、以下の三原則を規定する。

#### **削除しない (No Delete)**

物理的な`DELETE`文の使用は禁止する。業務上の「取り消し」や「スキップ」は、例えば「未回収フラグ（`is_skipped=true`）」を立てるといった論理的な状態で表現する。過去の計画が誤りであったとしても、その「誤りがあった」という事実自体が、記録されるべき重要な履歴である。

#### **上書きしない (No Overwrite)**

`daily_jobs`や`route_shifts`といった重要な業務レコードの直接的な`UPDATE`を原則として禁止する。全ての変更は、`event_logs`への追記（INSERT-only）によって行われなければならない。記録すべき必須項目は、`before`（変更前）、`after`（変更後）、`is_admin_forced`（強制操作フラグ）、`timestamp`、そして`reason`（理由）である。

#### **理由を残す (Keep Reason)**

実績の修正や管理者による強制操作など、業務の正当性が問われる可能性のある操作においては、理由（`correction_reason`）の記録をシステムレベルで必須とする。理由なき変更は、システムの信頼性を根底から破壊する行為であり、技術的にも業務的にも絶対に許容しない。

これらの原則は、システムを単なるデータ記録装置から、信頼できる「証跡記録装置」へと昇華させる。不変の履歴から生まれるこの検証可能な信頼こそが、全ての利用者からの信頼を築く土台となり、直感的な操作を可能にするUI/UX設計へと繋がっていく。

\--------------------------------------------------------------------------------

### **5\. UI/UX設計原則：判断と実行の分離による誤操作防止**

本原則は、DX設計憲法の「人間の最終判断権は常に最優先」という理念を、物理的なインターフェースとして具現化するものである。その目的は、利用者のITリテラシーに依存することなく、業務トラブルに直結する重大な誤操作を未然に防ぐことにある。これを実現するため、全ての操作が「判断」と「実行」のどちらのフェーズにあるかをユーザーが直感的に理解できる設計を目指し、操作の意図を明確に分離する。

#### **5.1 操作の意図の分離**

**シングルクリック（タップ）** 「文脈を開く」操作と定義する。データの状態確認や詳細情報の表示に限定され、この操作によってデータが変更されることはない。

**ダブルクリック** 原則として**使用しない**。我々はダブルクリックを明確に禁止する。なぜなら、これは緊張度の高い業務UIにおいて意図しないデータ変更を引き起こす最も一般的な原因であり、一瞬の躊躇が取り返しのつかないエラーへと繋がりうるからだ。

**右クリック（長押し）** 既存の機能への「ショートカット」に限定する。例えば、シングルクリックで表示されるメニュー内の項目を直接呼び出すために使用する。右クリックでしか使えない独自の機能は作らない。

#### **5.2 ジェスチャーの抽象化とタブレット対応**

将来的なデバイスの多様化を見据え、操作方法（ジェスチャー）と業務上の意味を分離し、PCとタブレットで一貫した操作体験を提供する。

| 業務意味 | デスクトップ操作 | タブレット操作 |
| :---- | :---- | :---- |
| 詳細を見る | シングルクリック | タップ |
| 操作候補を開く | 右クリック | 長押し |
| 配車を準備する | ドラッグ＆ドロップ | ドラッグ＆ドロップ |
| 配車を決定する | 確認UI上の実行ボタン | 確認UI上の実行ボタン |

これらの原則は、判断を伴う重い操作（例：配車の確定）を、軽量で取り消し可能なUIジェスチャー（例：ドラッグ＆ドロップ）から意図的に切り離している。全ての重要な変更は、必ず利用者の明確な意思表示（確認UI上の実行ボタン押下）を介して行われる。この設計思想により、システムの安全性と直感的な操作性が両立されるのである。

\--------------------------------------------------------------------------------

### **6\. 結論：一貫したOSとしての将来展望**

これまで定義してきた5つの原則は、単一のアプリケーションのためだけのものではない。これらは相互に連携し、事業所全体の業務を支える、一貫した思想を持つ共通の「ビジネスOS」を形成する。このOSの上に、将来様々な業務アプリケーションが構築されていくことで、その真価は最大限に発揮される。

#### **「休みシフトアプリ」への展開**

スタッフの勤務変更は、単なる上書きや削除であってはならない。本OSのログ設計原則を適用し、「有給」「休出」「代休」といった変更を、理由を伴う業務上の「イベント」として記録する。これにより、誰がいつ、なぜシフト変更を行ったのかが構造化されたデータとして完全に追跡可能となり、労務管理の透明性が飛躍的に向上する。

#### **「車両予約アプリ」への展開**

「オイル交換」「車検」「修理」といった車両メンテナンスは、単なる時間枠の予約ではない。本OSの思想に基づき、これを回収業務と同じ「案件カード」の一種として扱うことで、メンテナンス計画を動的配車計画と完全に連携させる。これにより、リソースのダブルブッキングといったヒューマンエラーをシステムレベルで防止する未来を描くことができる。

これらの設計原則に一貫して従うこと。それは、「業務として正しい」状態をシステムの構造に翻訳し、現場担当者の「書かなくていい判断を増やす」ための仕組みを築くことに他ならない。このOSは、我々の集合的な判断力を外部化し、将来の業務上の「事故」を未然に防ぐための、最も確実な投資である。変化に強く、現場で深く信頼され、長期的な事業価値を生み出し続けるシステム群を構築する、唯一の道であると確信している。
