# **インテリジェント動的配車管理アプリケーション：ドライバー向け要件定義書（統合版）**

## **1\. プロジェクトの戦略的ビジョンと経済的目標**

現場におけるデジタル化の真価は、単なる「紙の帳票の電子化」ではない。それは、物流の最前線を経営戦略へ直結させ、不透明な現場判断を透明な資産へと変える「データ駆動型物流」への構造的転換である。本システムにおいて、ドライバーは単なる運搬作業者ではなく、現場の意思決定を構造化データとして生成する「エッジ・センサー」として再定義される。

### **1.1 プロジェクトビジョンと哲学的基盤**

本プロジェクトの核心は、予測的かつ自己最適化する物流基盤の構築にある。現場の属人的な経験や判断を「構造化データ」へと変換し、組織全体の知性へと昇華させる。ドライバーの判断はリアルタイムでシステムにフィードバックされ、それ自体がシステムの自律的な進化を支える。本要件定義では、AIや外部ナレッジに頼るのではなく、「現場判断の徹底的な構造化データ化」をその核に据える。

### **1.2 ビジネス価値（KGI/KPI）の定義**

本システムの導入により、以下の具体的な経済的目標を達成し、経営の透明性を確保する。

* **業務効率化（KPI）**  
  * **日報作成時間の100%削減**: ステータス更新と連動した完全自動生成。  
  * **帰社後の事務作業50%削減**: 重量按分ロジックの自動化による事務負担の排除。  
* **ビジネスインパクト（KGI）**  
  * **平均走行距離15%削減**: ルート最適化とリアルタイム指示による配送効率の極大化。  
  * **燃料費不正請求90%削減**: 給油報告のデジタル化とODOメーター照合による不正抑止。

### **1.3 SDR（State/Decision/Reason）モデルの採用**

データの信頼性と監査耐性を担保するため、「事実（State）」「判断（Decision）」「理由（Reason）」を分離して記録するSDRモデルを採用する。本アーキテクチャの最大の特徴は、全ての操作が `daily_jobs` テーブルの直接更新ではなく、意思決定の記録として `event_logs` に発行される点にある。「誰が、いつ、どのような理由で、どのような状態へ変更したか」を決定イベントとして蓄積することで、現場の例外的な判断も経営改善のための構造化データとして保存される。

これらの高次元な目標を達成するためには、現場のオペレーションをシステム的に律し、ヒューマンエラーを構造的に排除する「厳格な現場の仕組み」が必要となる。

\--------------------------------------------------------------------------------

## **2\. 業務遂行プロセスとステートマシン制御**

現場における誤操作を物理的・システム的に排除することは、データの整合性を守るだけでなく、ドライバーの安全と法的遵守を担保する戦略的防壁となる。

### **2.1 始業前およびミッション管理要件**

* **日常点検報告**: 始業前、タイヤやライト等の点検項目をアプリ上で報告する。このデータはGoogleスプレッドシートへ自動追記され、運行管理上の証跡となる。  
* **ミッションリストと地図連携**: OpenStreetMap（OSM）を基盤とした地図上に、訪問順序に従った地点をプロットする。外部ナビ（Googleマップ等）とのワンタップ連携を必須仕様とする。

### **2.2 厳格なステータス遷移（L1制約）**

データの信頼性を損なう恣意的な操作を防ぐため、以下のシーケンス制御ルールを課す。

* **単一アクティブ制御**: 現在進行中以外のミッションは全てグレーアウトし、操作不能とする。  
* **非活性化制御**: 状態が「到着（LOADING）」に遷移するまで、重量入力および出発報告ボタンを非活性（Disabled）とする。  
* **車両固定制約（FIXED\_UNTIL\_RETURN）**: 入場制限のある特定の案件を開始してから、拠点（Base）に戻り荷下ろしを完了するまで、「車両スワップ」機能をシステム側で完全に無効化する。

### **2.3 操作支援機能と監査証跡**

* **接近検知と通知**: GPSにより目的地への接近を自動検知する。アプリがフォアグラウンド実行されている場合、バイブレーションによる触覚フィードバックを行い、ドライバーに「到着」操作を促す。  
* **時刻修正と不可視記録**: ボタンの押し忘れに対応するため、5分前・15分前といった過去時刻の選択を許容する。ただし、時刻修正時には「実際の実行時刻」と「実行時のGPS位置情報」を `Audit_Logs` に不可視の状態で自動記録し、事後の整合性検証を可能にする。

### **2.4 シーケンス編集（自律的順序変更）モード**

渋滞等の突発的事態に対し、ドライバーによる順序変更を許可するが、そのプロセスを厳格に監査する。

* **トリガーと確定**: 未完了リストのドラッグ＆ドロップにより移行。最終確認ダイアログを経て確定される。  
* **Audit Keyの保持**: 以下の具体的アクションをログに記録する。  
  * 開始時：`action: start_sequence_edit`  
  * 確定時：`action: confirm_sequence_edit`（変更前後のシーケンス情報を保持）  
  * キャンセル時：`action: cancel_sequence_edit`

このステートマシン制御によって確保された「正しい作業プロセス」の上に、次に説明する「実績報告の精度」が構築される。

\--------------------------------------------------------------------------------

## **3\. 実績報告・重量按分・画像記録のロジック**

現場での迅速な「概算入力」と、拠点での厳格な「計量データ」を融合させる二段階プロセスは、正確な収支管理を行うための核となる。

### **3.1 二段階重量報告システムの詳細仕様**

現場の入力負荷を軽減しつつ、最終的な実績を確定させるため、以下のステップを踏む。

1. **現場での品目別概算入力**: 回収地点にて、品目ごとに概算重量を入力する。この際、現場の負担軽減のため「10kg単位の丸め処理（10kg未満の四捨五入/切り捨て）」をシステム側で自動適用する。  
2. **拠点での総重量入力**: 拠点（Base）に戻り、計量器で計測した「正味総重量」を入力する。  
3. **自動按分アルゴリズム（AutoSplitter）**: 拠点への帰還を境界とする `batch_index`（荷下ろし回数）単位で、以下の計算式に基づき実績重量を算出する。  
   * `案件実績 = 拠点正味総重量（バッチ単位） × (現場入力案件重量 / 現場入力総重量（バッチ単位）)`

### **3.2 バリデーションと整合性（差分ゼロ制御）**

データの不整合を許さないため、以下の「説明責任（Accountability）」要件を設ける。

* **差分ゼロ強制**: 各案件に割り振られた「調整後の合計重量」と、入力された「拠点総重量」の差分が完全にゼロになるまで、報告完了ボタンを活性化させない。  
* **修正理由の必須化**: 拠点重量との乖離により修正が発生した際、修正理由コード（Correction Reason）の選択と、補足テキスト（Supplement）の入力を必須とする。

### **3.3 付帯業務の報告仕様**

* **画像記録**: 現場写真は自動圧縮後、Cloudflare R2へアップロードされ、案件データと紐付けられる。  
* **給油報告**: 給油量、金額、ODOメーター、レシート写真を報告し、Googleスプレッドシートへ自動反映させる。  
* **計画外業務**: 突発的な案件は配車担当者がシステム上で追加し、リアルタイムでドライバーのリストを更新する。

現場のデータ入力精度は、次に詳述するUI/UX設計によって強力にバックアップされ、ドライバーの負担を最小限に抑える「安全装備」として機能する。

\--------------------------------------------------------------------------------

## **4\. プロフェッショナルUI/UXおよびアクセシビリティ**

過酷な屋外環境におけるUI設計は、単なる「使いやすさ」の追求ではなく、ドライバーの安全を確保し、操作ミスを構造的に防ぐための重要な「安全装備」である。

### **4.1 視認性とアクセシビリティの厳格な適用**

* **WCAG 2.1 AA準拠**: 直射日光下でも判別可能な高コントラスト設計、大型ボタンを採用する。  
* **多重情報提示**: 状態の変化を色のみで表現することを禁止する。必ず「Lucideアイコン ＋ テキスト」を併記する。  
  * 例：遅延発生時 ＝ 赤色 ＋ 警告アイコン（AlertTriangle） ＋ 「遅延中」と表示。

### **4.2 操作ジェスチャと業務意味の対応**

直感的かつ誤操作を防ぐため、以下の体系に限定し、ダブルクリックは誤作動防止のため原則禁止とする。

* **シングルタップ**: 詳細表示、項目選択。  
* **長押し**: コンテキストメニュー（完了・例外報告等）の呼び出し。  
* **ドラッグ**: シーケンスの並び替え（編集モード時のみ）。

### **4.3 業務の視覚的区別とLucideアイコン適用ルール**

特殊な活動は「Read-only Locked Card」として表示し、ドライバーによる移動・削除を不可とする。また、以下のアイコンを適用し、業務の直感性を高める。

* **Wrench (レンチ)**: 車両整備、修理、オイル交換。  
* **Helmet (ヘルメット)**: 現場作業（選別応援、サイトワーク）。  
* **Lock (錠前)**: 車両固定区間（L1制約対象）。  
* **Coffee (コーヒー)**: 休憩（BREAK）。

優れたUIが現場の負担を軽減し、オフライン環境下でもその価値を維持するための技術的裏付けが、次章の堅牢な基盤である。

\--------------------------------------------------------------------------------

## **5\. 技術基盤・オフライン戦略・セキュリティ**

無料枠内での開発という制約を「プロフェッショナルなリソース最適化」と捉え、効率的かつ堅牢なアーキテクチャを構築する。

### **5.1 オフラインファーストおよび同期アルゴリズム**

通信が不安定な現場を想定し、IndexedDBを用いたFIFO（先入れ先出し）方式のデータ同期を採用する。

* **同期競合の解決（Admin Priority）**: オフライン中のドライバー入力と管理側の操作が競合した場合、サーバー側の「管理者状態」を絶対優先とする。競合したローカルデータは破棄され、アプリ上に「管理者がスケジュールを更新しました」という通知と共に最新状態を強制反映させる。

### **5.2 非機能要件とパフォーマンス**

* **目標性能**: 主要ボタンの応答時間は3秒以内、稼働率99.5%以上のSLOを設定する。  
* **リソース監視**: SupabaseおよびCloudflareの無料枠使用量が80%に達した際、管理者に自動アラートを通知し、サービス停止を未然に防ぐ。

### **5.3 セキュリティと認可構造**

Supabase Authによる認証に加え、Row Level Security（RLS）による厳格なデータアクセス制限を行う。これにより、ドライバーは自身の担当範囲外のデータにアクセスすることを物理的に遮断される。

これらの技術的基盤が、将来的な拡張性を担保しつつ、次に示すデータモデルの整合性を支えている。

\--------------------------------------------------------------------------------

## **6\. データモデルとシステム監査**

本システムのデータ構造は、長期的なビジネス価値と、物流業者に求められる厳格な監査耐性を担保するための心臓部である。

### **6.1 主要エンティティの定義**

* **`daily_jobs`**: 当日の案件ステータスを管理。`batch_index`（重量按分のグルーピングキー）や `lock_vehicle_until_return`（車両固定フラグ）といった、動的制御の核となる変数を保持する。  
* **`collection_records`**: 回収の「事実」を記録。概算重量（10kg単位）、修正理由コード、突発品目フラグを格納する。  
* **`event_logs`**: SDRモデルの核。Actor、Timestamp、Decision、Reason、Stateの変化を時系列で完全に保持する。

### **6.2 監査可能性（Auditability）の確保**

本システムは、全てのボタン操作に対し「操作時刻」「サーバー同期時刻」「GPS位置情報」の三点セットを100%記録する。これにより、万が一の不正行為や事故発生時において、追跡可能性（Traceability）を完全に確保し、説明責任を果たせる体制を確立する。

以上の要件は、ビジネス戦略・現場のオペレーション・技術基盤の三位一体を達成するものであり、本アプリケーションを物流DXにおける次世代のスタンダードへと押し上げるものである。

