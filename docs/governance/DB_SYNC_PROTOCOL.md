# DB同期プロトコル (CLI Upgrade Protocol)

## 目的
AIが生成したマイグレーション（SQL）と、DBの実態（ローカル/リモート）、およびフロントエンドの型定義を完全に一致させ、不整合によるシステムダウンや開発遅延を防止する。

## プロトコル手順

### 1. マイグレーションの生成 (AI)
- AIは必要なスキーマ変更を SQL ファイルとして `supabase/migrations/` に作成する。
- ユーザーに対し、作成したファイル名と**環境に合わせた実行コマンド**を提示する。

### 2. DBへの反映 (人間)
反映先に応じて、以下の手段を選択する。

| 対象環境 | 推奨コマンド / 手段 | 前提条件 |
|---|---|---|
| **ローカル** | `npx supabase migration up` | CLI, Docker(supabase start) が起動していること |
| **リモート** | `npx supabase db push` | CLI連携(`-linked`)、ネットワーク通信が可能であること |
| **リモート(緊急/制限時)** | **SQL Editor へのコピペ** | CLIからのアクセスが制限されている場合の最終手段 |

- 実行後、AIに「実行完了」or 「失敗」を通知する。

### 3. 同期確認と型更新 (AI)
- **必須ステップ**: AIは実装フェーズ（Action）に入る前に必ず以下の確認を行う。
    1.  `npx supabase gen types typescript --linked` を実行（リモート同期の場合）。
    2.  物理DBから取得した最新の `database.types.ts` と、AIのモデル定義が一致しているか突き合わせる。
- **停止要件**: 物理DBにカラムが存在しない場合、AIは直ちに **STOP PROTOCOL** を発動し、同期が完了するまで実装を拒否する。

## 運用上の鉄則
- **物理優先の原則**: アプリ側の型定義（`index.ts`等）を「DBにあるつもり」で先に直すことは禁止。必ず「DB反映 → 型再生成 → アプリ実装」の順序を守る。
- **順序管理**: マイグレーションはタイムスタンプ順に実行されるため、過去のファイルを書き換えずに必ず新しいファイルを追加して `up/push` する。

---
*本プロトコルは [AGENTS.md](file:///c:/Users/shiyo/開発中APP/RePaper%20Route/AGENTS.md) の第2層（F. DB & DOM Governance）によって強制される。*
